import{renderToString as r}from"react-dom/server";import{StaticRouter as t,Routes as e,matchRoutes as n,matchPath as o}from"react-router";import{renderRoutes as i}from"@react5/router-layout";import a from"serialize-javascript";import{RootContextProvider as c,createServerStore as u}from"@react5/reducer";import{I18nextProvider as l}from"react-i18next";import{jsx as s}from"react/jsx-runtime";import p from"parseurl";import f from"fs";var m=function(n,o,u,p,f){var m=function(r){var t,e,n,o,i=null===(t=r.i18n)||void 0===t||null===(t=t.languages)||void 0===t?void 0:t[0],a=null===(e=r.i18n)||void 0===e||null===(e=e.reportNamespaces)||void 0===e?void 0:e.getUsedNamespaces();return a&&(n={},null===(o=r.i18n)||void 0===o||null===(o=o.languages)||void 0===o||o.forEach(function(t){n[t]={},a.forEach(function(e){n[t][e]=r.i18n.services.resourceStore.data[t][e]})})),{initialLanguage:i,initialI18nStore:n}}(p),d=m.initialLanguage,v=m.initialI18nStore,b=s(l,{i18n:p.i18n,children:s(t,{location:p.url,children:s(c,{reducer:n,initialState:null==f?void 0:f.root,children:s(e,{children:i(u)})})})}),y=r(b),h="production"===process.env.NODE_ENV?'<script src="/static/js/service-worker.js" defer><\/script>':"",g={}.helmet,O=g&&g.title?g.title.toString():"",w=g&&g.meta?g.meta.toString():"";return o.replace('<div id="app"></div>','<div id="app">'.concat(y,"</div>\n      <script>\n        window.INITIAL_STATE = ").concat(a(f.root),";\n        window.INITIAL_LANGUAGE = '").concat(d,"';\n        window.INITIAL_I18N_STORE = ").concat(a(v),";\n      <\/script>\n      ").concat(h)).replace("\x3c!-- META --\x3e","".concat(O,"\n      ").concat(w))};function d(r){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},d(r)}function v(r){var t=function(r,t){if("object"!=d(r)||!r)return r;var e=r[Symbol.toPrimitive];if(void 0!==e){var n=e.call(r,t);if("object"!=d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(r)}(r,"string");return"symbol"==d(t)?t:t+""}function b(r,t,e){return(t=v(t))in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}function y(r,t){var e=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable})),e.push.apply(e,n)}return e}function h(r){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{};t%2?y(Object(e),!0).forEach(function(t){b(r,t,e[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(e)):y(Object(e)).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(e,t))})}return r}var g=function(r,t,e,i){return function(a,c,l){var s=p(a),d=s?s.search:"",v=s?s.pathname:"",b=h(h({},a.cookies),{},{setCookies:c.cookie.bind(c)}),y=i?{services:i(b)}:{},g=u(t,y,null),w=f.readFileSync(r,"utf8"),S=n(e,v||"");if(!S)return c.statusCode=404,void l("Not found");var j=S.map(function(r){var t,e=r.route;if(e.path){var n=o({path:e.path},a.url);t=null==n?void 0:n.params}var i=e;return i.loadData?i.loadData(g.dispatch,b,d,t):null}).map(function(r){if(r)return new Promise(function(t){r.then(t).catch(t)})});Promise.all(j).then(function(){var r=m(t,w,e,a,g);O(c,r),l()}).catch(function(r){O(c,"Error happens: "+r),l()})}};function O(r,t){r.statusCode=r.statusCode||200,r.setHeader("Content-Type","text/html; charset=UTF-8"),r.setHeader("X-Powered-By","react-ssr-web"),r.end(t)}export{g as reactSsr,m as renderHtml};
