import{renderToString as r}from"react-dom/server";import{StaticRouter as t,Routes as e,matchRoutes as o,matchPath as n}from"react-router";import{renderRoutes as i}from"@react5/router-layout";import c from"serialize-javascript";import{RootContextProvider as a,createServerStore as u}from"@react5/reducer";import{I18nextProvider as l}from"react-i18next";import{HelmetProvider as s,renderMetaTags as p}from"@react5/helmet";import{jsx as f}from"react/jsx-runtime";import m from"parseurl";import d from"fs";var v=function(o,n,u,m,d){var v=function(r){var t,e,o,n,i=null===(t=r.i18n)||void 0===t||null===(t=t.languages)||void 0===t?void 0:t[0],c=null===(e=r.i18n)||void 0===e||null===(e=e.reportNamespaces)||void 0===e?void 0:e.getUsedNamespaces();return c&&(o={},null===(n=r.i18n)||void 0===n||null===(n=n.languages)||void 0===n||n.forEach(function(t){o[t]={},c.forEach(function(e){o[t][e]=r.i18n.services.resourceStore.data[t][e]})})),{initialLanguage:i,initialI18nStore:o}}(m),b=v.initialLanguage,y=v.initialI18nStore,h={meta:[],link:[]},g=f(s,{context:h,children:f(l,{i18n:m.i18n,children:f(t,{location:m.url,children:f(a,{reducer:o,initialState:null==d?void 0:d.root,children:f(e,{children:i(u)})})})})}),O=r(g),w="production"===process.env.NODE_ENV?'<script src="/static/js/service-worker.js" defer><\/script>':"",S=h.title,j=h.meta,P=S||"",E=j?p(j):"";return n.replace('<div id="app"></div>','<div id="app">'.concat(O,"</div>\n      <script>\n        window.INITIAL_STATE = ").concat(c(d.root),";\n        window.INITIAL_LANGUAGE = '").concat(b,"';\n        window.INITIAL_I18N_STORE = ").concat(c(y),";\n      <\/script>\n      ").concat(w)).replace("\x3c!-- META --\x3e","".concat(P,"\n      ").concat(E))};function b(r){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},b(r)}function y(r){var t=function(r,t){if("object"!=b(r)||!r)return r;var e=r[Symbol.toPrimitive];if(void 0!==e){var o=e.call(r,t);if("object"!=b(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(r)}(r,"string");return"symbol"==b(t)?t:t+""}function h(r,t,e){return(t=y(t))in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}function g(r,t){var e=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable})),e.push.apply(e,o)}return e}function O(r){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{};t%2?g(Object(e),!0).forEach(function(t){h(r,t,e[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(e)):g(Object(e)).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(e,t))})}return r}var w=function(r,t,e,i){var c=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return function(a,l,s){var p=m(a),f=p?p.search:"",b=p?p.pathname:"",y=O(O({},a.cookies),{},{setCookies:l.cookie.bind(l)}),h=i?{services:i(y)}:{},g=u(t,h,null),w=d.readFileSync(r,"utf8"),j=o(e,b||"");if(!j)return l.statusCode=404,void s("Not found");var P=j.map(function(r){var t,e=r.route;if(e.path){var o=n({path:e.path},a.url);t=null==o?void 0:o.params}var i=e;return i.loadData?i.loadData(g.dispatch,y,f,t):null}).map(function(r){if(r)return new Promise(function(t){r.then(t).catch(t)})});Promise.all(P).then(function(){var r=v(t,w,e,a,g);S(l,r),s()}).catch(function(r){c&&console.error("SSR error:",r instanceof Error?r.stack||r.message:r),S(l,"Error happens: "+r),s()})}};function S(r,t){r.statusCode=r.statusCode||200,r.setHeader("Content-Type","text/html; charset=UTF-8"),r.setHeader("X-Powered-By","react-ssr-web"),r.end(t)}export{w as reactSsr,v as renderHtml};
